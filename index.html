<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Jornada das Belas Pedras - Sala de Testes V10</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c2137; /* Roxo escuro místico */
            color: #d3c6a6;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated; /* Garante o visual retro crocante */
        }

        /* UI Overlay para Diálogos */
        #ui-layer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background: #e6dcc3; /* Papel antigo */
            border: 4px solid #8b5a2b;
            border-radius: 4px;
            padding: 15px;
            display: none;
            box-shadow: 0 4px 0 #5c3a1e;
            pointer-events: none; 
            font-size: 14px;
            color: #2c1810;
            line-height: 1.4;
            z-index: 200;
        }

        #ui-name {
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
            color: #8b0000;
        }

        #ui-text {
            white-space: pre-wrap;
        }

        /* UI de Informação Global (Vida e Inventário) */
        #status-area {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #health-bar {
            width: 150px;
            height: 20px;
            background-color: #555;
            border: 2px solid #fff;
            border-radius: 4px;
            overflow: hidden;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 0 #000;
        }

        #health-fill {
            height: 100%;
            background-color: #e74c3c;
            width: 100%;
            transition: width 0.3s ease-out;
        }
        
        #inventory-display {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            width: 150px;
        }
        
        #inventory-list {
            margin-top: 5px;
            list-style: none;
            padding: 0;
        }

        /* Instruções no canto */
        #controls-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            color: white;
            font-size: 10px;
            pointer-events: none;
            z-index: 100;
            border-radius: 4px;
        }

        /* Feedback da Habilidade Fiódor */
        #fiodor-detection {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(46, 204, 113, 0.7);
            padding: 8px;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            display: none;
            z-index: 100;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

    <div id="controls-hint">
        WASD/Setas: Mover<br>
        1, 2, 3: Trocar Gato<br>
        ESPAÇO: Ação/Interagir/Habilidade<br>
        OBJETIVO: Passar pelo Burocrata e sobreviver ao Deserto.
    </div>

    <div id="status-area">
        <div id="health-bar">
            <div id="health-fill"></div>
            HP: <span id="health-value">100</span>
        </div>
        <div id="inventory-display">
            Inventário:
            <ul id="inventory-list">
                <!-- Itens serão injetados aqui -->
            </ul>
        </div>
    </div>

    <div id="fiodor-detection">
        RISCO DETETADO! (Fiódor)
    </div>

    <div id="game-container"></div>

    <div id="ui-layer">
        <div id="ui-name">???</div>
        <div id="ui-text">...</div>
    </div>

    <script>
        // CONFIGURAÇÕES GERAIS
        const TILE_SIZE = 32;
        const SCREEN_WIDTH = 640;
        const SCREEN_HEIGHT = 480;
        const WORLD_WIDTH = 800;
        const WORLD_HEIGHT = 600; 

        // --- CLASSE PRINCIPAL DO JOGO ---
        class MainScene extends Phaser.Scene {
            constructor() {
                super({ key: 'MainScene' });
                this.assistants = [];
                this.activeAssistantIndex = 0; 
                this.isDialogueOpen = false;
                this.playerHealth = 100;
                this.lastDamageTime = 0; 
                this.lastHeatDamageTime = 0; // Timer específico para o calor
                this.fiodorDetectionUI = null; 
                this.currentRoom = 1;
                this.player = null;
                this.koffe = null;
                this.selector = null;
                this.currentBackground = null; 
            }

            preload() {
                // GERAÇÃO DE ASSETS (Pixel Art via Código)
                const graphics = this.make.graphics({ x: 0, y: 0, add: false });

                // 1. Denise (Arqueóloga)
                graphics.clear();
                graphics.fillStyle(0xe0ac69); 
                graphics.fillRect(8, 4, 16, 14); 
                graphics.fillStyle(0x4a3000); 
                graphics.fillRect(6, 2, 20, 8);
                graphics.fillRect(6, 6, 4, 12);
                graphics.fillRect(22, 6, 4, 12);
                graphics.fillStyle(0x8fbc8f); 
                graphics.fillRect(8, 18, 16, 14);
                graphics.fillStyle(0x5c4033); 
                graphics.fillRect(10, 32, 5, 12);
                graphics.fillRect(17, 32, 5, 12);
                graphics.lineStyle(2, 0xc0c0c0); 
                graphics.strokeCircle(12, 10, 3);
                graphics.strokeCircle(20, 10, 3);
                graphics.generateTexture('denise', 32, 48);

                // 2. Maron (Preta)
                graphics.clear();
                graphics.fillStyle(0x1a1a1a);
                graphics.fillRect(4, 12, 24, 16); 
                graphics.fillRect(4, 4, 8, 8); 
                graphics.fillStyle(0xffffff); 
                graphics.fillRect(5, 6, 2, 2);
                graphics.fillStyle(0xff69b4); 
                graphics.fillRect(8, 12, 4, 2);
                graphics.generateTexture('maron', 32, 32);

                // 3. Fiódor (Branco/Dourado)
                graphics.clear();
                graphics.fillStyle(0xfff8dc); 
                graphics.fillRect(4, 12, 24, 16);
                graphics.fillRect(4, 4, 8, 8);
                graphics.fillStyle(0xdaa520); 
                graphics.fillRect(10, 14, 4, 12);
                graphics.fillStyle(0x00bfff); 
                graphics.fillRect(5, 6, 2, 2);
                graphics.generateTexture('fiodor', 32, 32);

                // 4. Orpheu (Siamês Gordo)
                graphics.clear();
                graphics.fillStyle(0xd2b48c); 
                graphics.fillRect(2, 10, 28, 20); 
                graphics.fillStyle(0x4b3621); 
                graphics.fillRect(2, 4, 10, 8); 
                graphics.fillRect(26, 12, 4, 4); 
                graphics.fillStyle(0xafeeee); 
                graphics.fillRect(4, 6, 2, 2);
                graphics.generateTexture('orpheu', 32, 32);

                // 5. Koffe (Fantasma)
                graphics.clear();
                graphics.fillStyle(0xe0ffff, 0.6); 
                graphics.fillCircle(16, 16, 12);
                graphics.fillRect(12, 20, 8, 10);
                graphics.fillStyle(0x000000); 
                graphics.fillRect(6, 8, 4, 8);
                graphics.generateTexture('koffe', 32, 32);

                // 6. Fungo Luminoso (Dano)
                graphics.clear();
                graphics.fillStyle(0x32cd32); 
                graphics.fillTriangle(16, 32, 4, 10, 28, 10);
                graphics.fillStyle(0x00ff00, 0.7); 
                graphics.fillCircle(16, 15, 10);
                graphics.generateTexture('fungus', 32, 32);

                // 7. Tiles / Cenário - CHÃO MADEIRA
                graphics.clear();
                graphics.fillStyle(0xcd853f); 
                graphics.fillRect(0, 0, 32, 32);
                graphics.lineStyle(2, 0xa0522d);
                graphics.strokeRect(0,0,32,32);
                graphics.generateTexture('floor', 32, 32);
                
                // NOVO: Chão de Areia (Deserto)
                graphics.clear();
                graphics.fillStyle(0xe6c288); 
                graphics.fillRect(0, 0, 32, 32);
                graphics.fillStyle(0xd4af73); 
                graphics.fillRect(5, 5, 2, 2);
                graphics.fillRect(20, 15, 2, 2);
                graphics.fillRect(10, 25, 2, 2);
                graphics.generateTexture('sand', 32, 32);

                // NOVO: Sombra (Zona Segura)
                graphics.clear();
                graphics.fillStyle(0x000000, 0.4); // Preto 40% opaco
                graphics.fillEllipse(16, 16, 30, 20);
                graphics.generateTexture('shadow', 32, 32);

                // Paredes de Pedra
                graphics.clear();
                graphics.fillStyle(0x708090); 
                graphics.fillRect(0, 0, 32, 32);
                graphics.fillStyle(0x2f4f4f);
                graphics.fillRect(4, 4, 24, 24);
                graphics.generateTexture('wall', 32, 32);

                // Paredes de Ruína (Deserto)
                graphics.clear();
                graphics.fillStyle(0x8b4513); 
                graphics.fillRect(0, 0, 32, 32);
                graphics.fillStyle(0xcd853f); 
                graphics.fillRect(4, 4, 10, 8);
                graphics.fillRect(18, 14, 10, 8);
                graphics.generateTexture('ruin_wall', 32, 32);
                
                // Portal 
                graphics.clear();
                graphics.fillStyle(0x00ffff);
                graphics.fillEllipse(16, 16, 20, 28);
                graphics.fillStyle(0x4682b4);
                graphics.fillRect(10, 10, 12, 12);
                graphics.generateTexture('portal', 32, 32);

                // Caixa Pesada
                graphics.clear();
                graphics.fillStyle(0x8b4513); 
                graphics.fillRect(2, 2, 28, 28);
                graphics.lineStyle(2, 0x000000);
                graphics.strokeRect(2,2,28,28);
                graphics.lineBetween(2, 2, 30, 30); 
                graphics.lineBetween(30, 2, 2, 30); 
                graphics.generateTexture('heavybox', 32, 32);

                // Cristal 
                graphics.clear();
                graphics.fillStyle(0xff1493); 
                graphics.fillTriangle(16, 2, 4, 30, 28, 30);
                graphics.generateTexture('crystal', 32, 32);

                // Item Papelada 
                graphics.clear();
                graphics.fillStyle(0x4682b4); 
                graphics.fillRect(6, 6, 20, 24);
                graphics.fillStyle(0xffffff);
                graphics.fillRect(8, 8, 16, 20);
                graphics.fillStyle(0x000000); 
                graphics.fillRect(10, 12, 12, 2);
                graphics.fillRect(10, 16, 12, 2);
                graphics.generateTexture('paper', 32, 32);

                // 8. Burocrata
                graphics.clear();
                graphics.fillStyle(0x8b0000); 
                graphics.fillRect(6, 10, 20, 20);
                graphics.fillStyle(0xffdead); 
                graphics.fillRect(8, 2, 16, 12);
                graphics.fillStyle(0x808080); 
                graphics.fillRect(8, 10, 16, 12);
                graphics.generateTexture('dwarf', 32, 32);
            }

            create() {
                this.fiodorDetectionUI = document.getElementById('fiodor-detection');
                
                this.registry.set('hasFormularioAzul', false);
                
                // --- CONFIGURAÇÃO DO MUNDO E CÂMARA ---
                this.physics.world.setBounds(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
                this.cameras.main.setBounds(0, 0, WORLD_WIDTH, WORLD_HEIGHT);

                // 1. Player
                this.player = this.physics.add.sprite(200, 200, 'denise');
                this.player.setCollideWorldBounds(true);
                this.player.body.setSize(16, 16);
                this.player.body.setOffset(8, 32); 
                
                this.cameras.main.startFollow(this.player, false); 
                this.cameras.main.setDeadzone(100, 100); 
                this.cameras.main.setZoom(2);
                this.player.setDepth(10); 

                // 2. Assistentes
                const maron = this.physics.add.sprite(180, 200, 'maron').setName("Maron").setBounce(0.5).setCollideWorldBounds(true);
                const fiodor = this.physics.add.sprite(160, 200, 'fiodor').setName("Fiódor").setBounce(0.5).setCollideWorldBounds(true);
                const orpheu = this.physics.add.sprite(140, 200, 'orpheu').setName("Orpheu").setBounce(0.5).setCollideWorldBounds(true);
                this.assistants.push(maron, fiodor, orpheu);
                this.assistants.forEach(cat => cat.setDepth(10)); 

                // 3. Koffe 
                this.koffe = this.add.sprite(0, 0, 'koffe');
                this.koffe.setAlpha(0);
                this.koffe.setDepth(10); 
                this.tweens.add({ targets: this.koffe, y: '+=5', duration: 1500, yoyo: true, repeat: -1 });
                
                // 4. Seletor
                this.selector = this.add.triangle(0, 0, 0, 0, 5, 10, 10, 0, 0xffff00);
                this.selector.setDepth(11); 

                // 5. Inputs
                this.cursors = this.input.keyboard.createCursorKeys();
                this.wasd = this.input.keyboard.addKeys('W,A,S,D');
                this.keys123 = this.input.keyboard.addKeys('ONE,TWO,THREE');
                this.keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                
                // 6. Listener de Inventário
                this.registry.events.on('changedata', this.updateInventoryUI, this);

                // --- CARREGAR A PRIMEIRA SALA ---
                this.loadRoom(1);
                
                this.updateInventoryUI();
                this.time.delayedCall(1000, () => {
                    this.triggerDialogue("Denise", "OK, voltamos. Vamos resolver a burocracia do An\u00E3o Burocrata. \n(Dica: Orpheu (3) empurra a caixa.)");
                });
            }
            
            loadRoom(roomNumber) {
                console.log(`Carregando Sala: ${roomNumber}`);
                
                // Destruição de objetos antigos
                if (this.currentBackground) this.currentBackground.destroy();
                if (this.walls) this.walls.clear(true, true);
                if (this.heavyBoxes) this.heavyBoxes.clear(true, true);
                if (this.triggers) this.triggers.clear(true, true);
                if (this.shadows) this.shadows.clear(true, true); // Novo grupo de sombras
                if (this.dwarf) this.dwarf.destroy();
                if (this.crystal) this.crystal.destroy();
                if (this.paper) this.paper.destroy();
                if (this.fungus) this.fungus.destroy();
                if (this.exitPortal) this.exitPortal.destroy();

                // Reinicializa Grupos
                this.walls = this.physics.add.staticGroup();
                this.heavyBoxes = this.physics.add.group({ bounceX: 0, bounceY: 0 }); 
                this.triggers = this.physics.add.staticGroup();
                this.shadows = this.physics.add.staticGroup(); // Grupo de Sombras

                // Reposicionar Personagens
                this.player.setPosition(200, 200);
                this.assistants.forEach((cat, index) => {
                    cat.setPosition(this.player.x - 30 - (index * 15), this.player.y);
                    cat.body.setVelocity(0, 0); 
                });

                if (roomNumber === 1) {
                    this.currentRoom = 1;
                    this.currentBackground = this.add.tileSprite(0, 0, WORLD_WIDTH, WORLD_HEIGHT, 'floor').setOrigin(0).setDepth(0);
                    
                    this.createRoom(2, 2, 18, 13, 'wall'); 
                    
                    this.dwarf = this.physics.add.staticSprite(550, 240, 'dwarf');
                    this.dwarf.name = "dwarf_blocker";
                    this.dwarf.setDepth(5);
                    
                    const box = this.heavyBoxes.create(300, 300, 'heavybox');
                    box.setImmovable(true); 
                    box.setCollideWorldBounds(true);
                    box.setDrag(800, 800); 
                    box.name = "HeavyBox";
                    box.startX = 300; 
                    box.startY = 300; 
                    box.setDepth(5);

                    this.crystal = this.physics.add.staticSprite(100, 350, 'crystal');
                    this.crystal.setDepth(5);
                    
                    this.paper = this.physics.add.staticSprite(300, 240, 'paper');
                    if (this.registry.get('hasFormularioAzul')) {
                        this.paper.disableBody(true, true);
                    } else {
                        this.paper.disableBody(true, true); 
                    }
                    this.paper.setDepth(5);

                    this.fungus = this.physics.add.staticSprite(450, 100, 'fungus'); 
                    this.fungus.name = "LuminousFungus";
                    this.fungus.setDepth(5);
                    this.tweens.add({ targets: this.fungus, alpha: 0.5, duration: 500, yoyo: true, repeat: -1 });

                    this.exitPortal = this.physics.add.staticSprite(this.dwarf.x, this.dwarf.y + 16, 'portal');
                    if (this.registry.get('hasFormularioAzul')) {
                         this.dwarf.disableBody(true, true); 
                         this.dwarf.setVisible(false);
                         this.exitPortal.enableBody(true, this.dwarf.x, this.dwarf.y + 16, true, true);
                    } else {
                        this.exitPortal.disableBody(true, true);
                    }
                    this.exitPortal.setDepth(5);

                    // Colisões Sala 1
                    this.physics.add.collider(this.player, this.heavyBoxes, this.handleBoxPush, null, this);
                    if (this.dwarf.active) {
                        this.physics.add.collider(this.player, this.dwarf, this.dwarfInteraction, null, this);
                    }
                    this.physics.add.overlap(this.assistants[0], this.crystal, this.handleCrystal, null, this); 
                    this.physics.add.overlap(this.player, this.paper, this.collectPaper, null, this);
                    this.physics.add.overlap(this.player, this.fungus, this.handleFungusDamage, null, this);
                    this.physics.add.overlap(this.player, this.exitPortal, () => {
                         if (this.exitPortal.active) this.loadRoom(2);
                    }, null, this);

                } else if (roomNumber === 2) {
                    this.currentRoom = 2;
                    this.currentBackground = this.add.tileSprite(0, 0, WORLD_WIDTH, WORLD_HEIGHT, 'sand').setOrigin(0).setDepth(0);
                    
                    this.createRoom(2, 2, 18, 13, 'ruin_wall');
                    this.player.setPosition(200, 200);

                    // Adicionar Sombras (Zonas Seguras)
                    this.createShadows();

                    this.triggerDialogue("Denise", "Sala 2: O Deserto. Que calor insuport\u00E1vel! \nPreciso ficar nas sombras para n\u00E3o desmaiar.");
                    
                    this.exitPortal = this.physics.add.staticSprite(550, 400, 'portal');
                    this.exitPortal.setVisible(true);
                    this.exitPortal.name = "return_portal";
                    this.exitPortal.setDepth(5);
                    this.physics.add.overlap(this.player, this.exitPortal, () => this.loadRoom(1), null, this);
                }
                
                // Colisões Globais
                this.physics.add.collider(this.player, this.walls);
                this.physics.add.collider(this.assistants, this.assistants); 
                this.assistants.forEach(cat => {
                    this.physics.add.collider(cat, this.walls); 
                    this.physics.add.collider(cat, this.player); 
                    if (this.heavyBoxes.children.entries.length > 0) {
                        this.physics.add.collider(cat, this.heavyBoxes); 
                    }
                });
            }

            createShadows() {
                // Cria sombras em locais estratégicos (atrás de "ruínas" imaginárias ou cantos)
                const shadowPositions = [
                    {x: 100, y: 100},
                    {x: 300, y: 300},
                    {x: 500, y: 150},
                    {x: 200, y: 400},
                    {x: 550, y: 350}
                ];

                shadowPositions.forEach(pos => {
                    const shadow = this.shadows.create(pos.x, pos.y, 'shadow');
                    shadow.setScale(2); // Sombra maior
                    shadow.setDepth(1); // Acima do chão, abaixo do player
                });
            }

            update(time, delta) {
                if (!this.player) return; 

                if (this.isDialogueOpen) {
                    this.player.setVelocity(0, 0);
                    this.assistants.forEach(a => a.setVelocity(0,0));
                    if (Phaser.Input.Keyboard.JustDown(this.keySpace)) {
                        this.closeDialogue();
                    }
                    return;
                }

                // Movimento Player
                const speed = 120;
                this.player.setVelocity(0); 
                if (this.cursors.left.isDown || this.wasd.A.isDown) this.player.setVelocityX(-speed);
                else if (this.cursors.right.isDown || this.wasd.D.isDown) this.player.setVelocityX(speed);
                if (this.cursors.up.isDown || this.wasd.W.isDown) this.player.setVelocityY(-speed);
                else if (this.cursors.down.isDown || this.wasd.S.isDown) this.player.setVelocityY(speed);
                this.player.body.velocity.normalize().scale(speed);
                
                // Movimento Gatos
                this.assistants.forEach((cat, index) => {
                    const distToPlayer = Phaser.Math.Distance.Between(cat.x, cat.y, this.player.x, this.player.y);
                    const minDistance = 50 + (index * 15); 
                    const followSpeed = speed * 0.9;
                    if (distToPlayer > minDistance) {
                        this.physics.moveToObject(cat, this.player, followSpeed); 
                    } else if (distToPlayer < 40) {
                        this.physics.moveToObject(cat, this.player, -followSpeed * 0.5); 
                    } else {
                        cat.setAcceleration(0, 0); 
                        cat.setAngularAcceleration(0);
                        cat.body.velocity.scale(0.95); 
                    }
                });

                // Lógica de Koffe
                if (this.playerHealth < 50) {
                    this.koffe.setAlpha(0.8);
                    this.koffe.x = Phaser.Math.Linear(this.koffe.x, this.player.x + 20, 0.05);
                    this.koffe.y = Phaser.Math.Linear(this.koffe.y, this.player.y - 30, 0.05);
                } else {
                    this.koffe.setAlpha(0);
                }

                // Troca de Gato
                if (Phaser.Input.Keyboard.JustDown(this.keys123.ONE)) this.setActiveAssistant(0);
                if (Phaser.Input.Keyboard.JustDown(this.keys123.TWO)) this.setActiveAssistant(1);
                if (Phaser.Input.Keyboard.JustDown(this.keys123.THREE)) this.setActiveAssistant(2);

                const activeCat = this.assistants[this.activeAssistantIndex];
                this.selector.x = activeCat.x - 5;
                this.selector.y = activeCat.y - 25;

                // Fiódor UI (Sala 1)
                if (this.currentRoom === 1 && this.fungus && this.fungus.active && activeCat.name === "Fiódor") {
                    this.checkFiodorDetection();
                } else {
                    this.fiodorDetectionUI.style.display = 'none';
                }

                // *** MECÂNICA DE CALOR (SALA 2) ***
                if (this.currentRoom === 2) {
                    // Verifica se o player está sobrepondo alguma sombra
                    const isSafe = this.physics.overlap(this.player, this.shadows);
                    
                    if (!isSafe) {
                        // Aplica dano a cada 2 segundos
                        if (time > this.lastHeatDamageTime + 2000) {
                            this.playerHealth = Math.max(0, this.playerHealth - 5);
                            this.lastHeatDamageTime = time;
                            
                            // Feedback Visual
                            this.cameras.main.shake(100, 0.005);
                            this.showFloatingText(this.player.x, this.player.y, "Calor! -5 HP", 0xff4500); // Laranja avermelhado

                            // Game Over check
                            if (this.playerHealth <= 0) {
                                this.triggerDialogue("Game Over", "O calor do deserto foi demais para voc\u00EA.");
                                this.scene.pause();
                            }
                        }
                    }
                }

                // Inputs de Ação
                if (Phaser.Input.Keyboard.JustDown(this.keySpace) && !this.isDialogueOpen) {
                    const distToDwarf = this.currentRoom === 1 && this.dwarf.active ? Phaser.Math.Distance.Between(this.player.x, this.player.y, this.dwarf.x, this.dwarf.y) : Infinity;
                    const interactionRange = 50; 
                    if (this.currentRoom === 1 && this.dwarf.active && distToDwarf < interactionRange) {
                        this.dwarfInteraction(this.player, this.dwarf);
                    } else {
                        this.performAssistantAction();
                    }
                }
                
                this.updateUI();
            }

            // --- LÓGICA DE JOGO ---

            dwarfInteraction(player, dwarf) {
                if (!Phaser.Input.Keyboard.JustDown(this.keySpace)) return;
                
                if (this.registry.get('hasFormularioAzul')) {
                    this.triggerDialogue("An\u00E3o Burocrata", "Ah, aqui est\u00E1. Excelente! O Visto 'A' para a Sala 2 foi concedido. Por favor, prossiga.");
                    
                    // CONSOME O ITEM (Remove do inventário)
                    this.registry.set('hasFormularioAzul', false);
                    
                    dwarf.disableBody(true, true);
                    this.tweens.add({ targets: dwarf, alpha: 0, duration: 800 });
                    
                    this.exitPortal.enableBody(true, this.dwarf.x, this.dwarf.y + 16, true, true);
                    this.exitPortal.setAlpha(1);
                    this.exitPortal.setDepth(5);
                    
                    this.time.delayedCall(1500, () => {
                        this.triggerDialogue("Denise", "Uma passagem abriu-se no local do An\u00E3o. Vamos em frente!");
                    });
                    
                } else {
                    this.triggerDialogue("An\u00E3o Burocrata", "Alto l\u00E1! Onde pensa que vai sem o Formul\u00E1rio Azul 2B? \n\n(Dica: Selecione Orpheu (3) e tente empurrar a caixa pesada pr\u00F3xima.)");
                }
            }

            handleFungusDamage(player, fungus) {
                if (this.currentRoom !== 1) return;
                const now = this.time.now;
                const damageInterval = 1000; 
                if (now > this.lastDamageTime + damageInterval) {
                    this.playerHealth = Math.max(0, this.playerHealth - 10);
                    this.lastDamageTime = now;
                    this.cameras.main.flash(100, 255, 0, 0); 
                    this.showFloatingText(player.x, player.y - 20, "-10 HP", 0xff0000);
                    if (this.playerHealth <= 0) {
                        this.playerHealth = 0;
                        this.triggerDialogue("Game Over", "Voc\u00EA sucumbiu ao veneno do Fungo Luminoso.");
                        this.scene.pause();
                    }
                }
            }
            
            checkFiodorDetection() {
                const detectionRange = 150; 
                const distToFungus = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.fungus.x, this.fungus.y);
                if (distToFungus < detectionRange) {
                    this.fiodorDetectionUI.style.display = 'block';
                } else {
                    this.fiodorDetectionUI.style.display = 'none';
                }
            }

            setActiveAssistant(index) {
                this.activeAssistantIndex = index;
                this.tweens.add({
                    targets: this.assistants[index],
                    scaleX: 1.2,
                    scaleY: 1.2,
                    duration: 100,
                    yoyo: true
                });
            }

            performAssistantAction() {
                const cat = this.assistants[this.activeAssistantIndex];
                if (cat.name === "Maron") {
                    const dist = Phaser.Math.Distance.Between(this.player.x, this.player.y, cat.x, cat.y);
                    if (dist < 50) {
                        this.playerHealth = Math.min(100, this.playerHealth + 10);
                        this.showFloatingText(cat.x, cat.y, "+10 HP \u2665 (Conforto)", 0x32cd32);
                    }
                } 
                else if (cat.name === "Orpheu") {
                    this.showFloatingText(cat.x, cat.y, "GORFFF! (For\u00E7a)");
                }
                else if (cat.name === "Fiódor") {
                    this.showFloatingText(cat.x, cat.y, "Zoom!");
                    const direction = new Phaser.Math.Vector2(this.player.body.velocity.x, this.player.body.velocity.y).normalize();
                    if (direction.lengthSq() === 0) direction.y = -1;
                    cat.body.setVelocity(direction.x * 300, direction.y * 300);
                }
            }

            handleBoxPush(player, box) {
                if (!box || !box.body || this.registry.get('hasFormularioAzul')) return;
                const activeAssistant = this.assistants[this.activeAssistantIndex];
                const activeCatIsOrpheu = activeAssistant && activeAssistant.name === "Orpheu";
                if (activeCatIsOrpheu) {
                    box.setImmovable(false); 
                    box.setVelocity(player.body.velocity.x * 0.7, player.body.velocity.y * 0.7); 
                    const distanceMoved = Phaser.Math.Distance.Between(box.x, box.y, box.startX, box.startY);
                    if (distanceMoved > 30 && !this.paper.active) {
                        this.paper.enableBody(true, box.x, box.y - 50, true, true);
                        this.triggerDialogue("Denise", "Olha s\u00F3! Algu\u00E9m derrubou o Formul\u00E1rio Azul 2B atr\u00E1s dessa caixa pesada.");
                    }
                } else {
                    box.setImmovable(true);
                    box.setVelocity(0);
                    if (Phaser.Input.Keyboard.JustDown(this.keySpace)) {
                        this.triggerDialogue("Denise", "\u00C9 muito pesado! Preciso de algu\u00E9m forte... Talvez o Orpheu (3)?");
                    }
                }
            }

            handleCrystal(maron, crystal) {
                if (Math.random() > 0.05) return; 
                this.tweens.add({ targets: crystal, alpha: 0.5, yoyo: true, duration: 200 });
            }

            collectPaper(player, paper) {
                paper.disableBody(true, true);
                this.registry.set('hasFormularioAzul', true); 
                this.triggerDialogue("Sistema", "Voc\u00EA obteve: Formul\u00E1rio Azul 2B! \n(Agora, fale com o An\u00E3o Burocrata na entrada. Pressione ESPA\u00C7O perto dele.)");
            }

            // --- UI & AUXILIARES ---

            createRoom(x, y, w, h, wallTexture = 'wall') {
                for (let i = x; i < x + w; i++) {
                    this.walls.create(i * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, wallTexture).setDepth(5); 
                    this.walls.create(i * TILE_SIZE + TILE_SIZE / 2, (y + h) * TILE_SIZE + TILE_SIZE / 2, wallTexture).setDepth(5); 
                }
                for (let j = y; j <= y + h; j++) {
                    this.walls.create(x * TILE_SIZE + TILE_SIZE / 2, j * TILE_SIZE + TILE_SIZE / 2, wallTexture).setDepth(5); 
                    this.walls.create((x + w) * TILE_SIZE + TILE_SIZE / 2, j * TILE_SIZE + TILE_SIZE / 2, wallTexture).setDepth(5); 
                }
            }

            showFloatingText(x, y, message, color = 0xffffff) {
                const text = this.add.text(x, y - 20, message, {
                    fontSize: '12px',
                    color: '#' + color.toString(16).padStart(6, '0'),
                    stroke: '#000',
                    strokeThickness: 2
                }).setOrigin(0.5).setDepth(20); 
                
                this.tweens.add({
                    targets: text,
                    y: y - 50,
                    alpha: 0,
                    duration: 1000,
                    onComplete: () => text.destroy()
                });
            }

            triggerDialogue(name, text) {
                this.isDialogueOpen = true;
                const ui = document.getElementById('ui-layer');
                const nameEl = document.getElementById('ui-name');
                const textEl = document.getElementById('ui-text');
                ui.style.display = 'block';
                nameEl.innerText = name;
                textEl.innerText = ""; 
                let i = 0;
                this.typingEvent = this.time.addEvent({
                    delay: 30,
                    callback: () => {
                        if (i < text.length) {
                             textEl.innerText += text[i];
                             i++;
                        } else {
                            this.typingEvent.destroy();
                        }
                    },
                    repeat: text.length - 1
                });
            }

            closeDialogue() {
                this.isDialogueOpen = false;
                document.getElementById('ui-layer').style.display = 'none';
                if (this.typingEvent) this.typingEvent.destroy();
            }

            updateUI() {
                const healthFill = document.getElementById('health-fill');
                const healthValue = document.getElementById('health-value');
                healthFill.style.width = `${this.playerHealth}%`;
                healthValue.innerText = this.playerHealth;
                if (this.playerHealth > 50) {
                    healthFill.style.backgroundColor = '#2ecc71'; 
                } else if (this.playerHealth > 20) {
                    healthFill.style.backgroundColor = '#f39c12'; 
                } else {
                    healthFill.style.backgroundColor = '#e74c3c'; 
                }
            }
            
            updateInventoryUI() {
                const inventoryList = document.getElementById('inventory-list');
                inventoryList.innerHTML = ''; 
                const hasFormulario = this.registry.get('hasFormularioAzul');
                if (hasFormulario) {
                    const li = document.createElement('li');
                    li.innerText = '• Formul\u00E1rio Azul 2B (\uD83D\uDD11)';
                    inventoryList.appendChild(li);
                } else {
                    const li = document.createElement('li');
                    li.innerText = '(Vazio)';
                    inventoryList.appendChild(li);
                }
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: SCREEN_WIDTH,
            height: SCREEN_HEIGHT,
            parent: 'game-container',
            backgroundColor: '#000000',
            pixelArt: true, 
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 }, 
                    debug: false
                }
            },
            scene: [MainScene]
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>
